<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>
	<script src="../../model/binTree.js" type="text/javascript"></script>
	<script src="../../model/users.js" type="text/javascript"></script>
	<script src="../../controllers/usersController.js" type="text/javascript"></script>
	
	<link rel="stylesheet" type="text/css" href="css/users.css">
	
	<script>
		var curSuggestions = [];
		var selectedSug = 0;
		
		function searchUsers() {
			var selUser = document.getElementById("searchText").value
			UsersController.search(selUser, populateSearchResult);
		}
		
		function populateSearchResult(result, error) {
			if (error != null && error != '') {
				document.getElementById("error").innerHTML = error;

				document.getElementById("id").innerHTML = '';
				document.getElementById("firstName").innerHTML = '';
				document.getElementById("title").innerHTML = '';
				document.getElementById("lastName").innerHTML = '';
				document.getElementById("userName").innerHTML = '';
				document.getElementById("email").innerHTML = '';
				document.getElementById("city").innerHTML = '';
				document.getElementById("country").innerHTML = '';
				document.getElementById("fav_color").innerHTML = '';
				document.getElementById("fav_color").style.backgroundColor = '';
				document.getElementById("blog").innerHTML = '';
			} else {
				document.getElementById("error").innerHTML = '';
				
				document.getElementById("id").innerHTML = result.id;
				document.getElementById("firstName").innerHTML = result.first_name;
				document.getElementById("title").innerHTML = result.title;
				document.getElementById("lastName").innerHTML = result.last_name;
				document.getElementById("userName").innerHTML = result.username;
				document.getElementById("email").innerHTML = result.email;
				document.getElementById("city").innerHTML = result.city;
				document.getElementById("country").innerHTML = result.country;
				document.getElementById("fav_color").style.backgroundColor = result.fav_color;

				var htmlBlog = '';
				var blogLink = result.blog;
				if (blogLink != null && blogLink.trim() != '') {
					htmlBlog = '<a href="' + blogLink + '"> Link </a>';
				}
				document.getElementById("blog").innerHTML = htmlBlog;
			}
		}
		
		function newUserEntered(event) {
			var keyPressedCode;

            if (window.event) { // IE					
            	keyPressedCode = event.keyCode;
            } else if (event.which) { // Netscape/Firefox/Opera					
            	keyPressedCode = event.which;
			} else {
				return;
			}
			switch(keyPressedCode) {
				case 38: //Arrow up key
				case 40: //Arrow down key
					var totalSug = curSuggestions.length;
					if (totalSug > 0) {
						if (keyPressedCode == 38) {
							selectedSug = (selectedSug <= 0) ? totalSug-1 : selectedSug-1;
						} else {
							selectedSug = (selectedSug+1) % totalSug;
						}
						promptSuggestions(curSuggestions);
					}
					break;
				case 13: //Enter key
					if (selectedSug != -1) {
						document.getElementById("searchText").value = curSuggestions[selectedSug];
						curSuggestions = [];
						hideSuggestions();
					}
					break;
				case 27: //Esc key
					hideSuggestions();
					break;
				default:
					//TODO Limitar los escenarios a cuando cambia el texto
					var enteredUser = document.getElementById("searchText").value;
					UsersController.suggest(enteredUser, getAndPromptSuggestions);
					break;
			}
		}
		
		function getAndPromptSuggestions(suggestions) {
			if (suggestions.length > 0) {
				selectedSug = 0;
			}
			promptSuggestions(suggestions);
			curSuggestions = suggestions;
		}
		
		function promptSuggestions(suggestions) {
			if (suggestions != null) {
				var listSugHTML = '';
				listSugHTML += '<ul id="sugList">';
				for (i in suggestions) {
					var selected = '';
					if (i == selectedSug) {
						selected = ' class ="selected" ';
					}
					listSugHTML += '<li'+selected+'>' + suggestions[i] + '</li>';
				}
				listSugHTML += '</ul>';
				document.getElementById("suggestions").style.display = "block";
				document.getElementById("suggestions").innerHTML = listSugHTML;
			}
		}
		
		function hideSuggestions() {
			selectedSug = -1;
			document.getElementById("suggestions").innerHTML = "";
			document.getElementById("suggestions").style.display = "none";
		}
		
		function promptSuggestionsIfLoaded() {
			if (curSuggestions.length > 0) {
				promptSuggestions(curSuggestions);
			}
		}
		
		function preventDefBehaviours(event) {
			var keyPressedCode;

            if (window.event) { // IE					
            	keyPressedCode = event.keyCode;
            } else if (event.which) { // Netscape/Firefox/Opera					
            	keyPressedCode = event.which;
			} else {
				alert('The suggestions cannot be displayed. Error: The entered key could not be processed');
				return;
			}
			
			if (keyPressedCode == 13 || keyPressedCode == 27) {
				event.preventDefault();
			}
		}
	</script>

	<title>People Profiles</title>

</head>

<body>

<h2>People Profiles</h2>

<table>
	<tr>
		<td>
			<label for="searchText">User name:</label>
		</td>
		<td>
			<input type="text" id="searchText"
				onKeyDown="preventDefBehaviours(event)"
				onKeyUp="newUserEntered(event)"
				onFocus="promptSuggestionsIfLoaded()"
				onBlur="hideSuggestions()" />
			<div id="suggestions"/>
		</td>
		<td>
			<button type="button" onclick="searchUsers()">Search</button>
		</td>
	</tr>
</table>

<table id="results">
	<colgroup>
		<col id="tagCol">
		<col id="valCol">
	</colgroup>
	<tr>
		<td>Error:</td>
		<td><textarea disabled id="error"></textarea></td>
	</tr>
	<tr>
		<td>Id:</td>
		<td><textarea disabled id="id"></textarea></td>
	</tr>

	<tr>
		<td>Title:</td>
		<td><textarea disabled id="title"></textarea></td>
	</tr>

	<tr>
		<td>First Name:</td>
		<td><textarea disabled id="firstName"></textarea></td>
	</tr>

	<tr>
		<td>Last Name:</td>
		<td><textarea disabled id="lastName"></textarea></td>
	</tr>

	<tr>
		<td>User Name:</td>
		<td><textarea disabled id="userName"></textarea></td>
	</tr>

	<tr>
		<td>Email:</td>
		<td><textarea disabled id="email"></textarea></td>
	</tr>

	<tr>
		<td>City:</td>
		<td><textarea disabled  id="city"></textarea></td>
	</tr>

	<tr>
		<td>Country:</td>
		<td><textarea disabled id="country"></textarea></td>
	</tr>

	<tr>
		<td>Favourite colour:</td>
		<td><textarea disabled id="fav_color"></textarea></td>
	</tr>

	<tr>
		<td>Blog:</td>
		<td id="blog"></td>
	</tr>

</table>

</body>
</html>
